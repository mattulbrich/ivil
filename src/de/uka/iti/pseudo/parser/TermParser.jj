
//
// This file contains partial parser defition for terms only
//


ASTTerm Term():
{ 
  ASTTerm term;
  List<ASTTerm> list = new ArrayList<ASTTerm>(); 
}
{

        ( term=OpIdentifier() { list.add(term); } )*
        term=AsTerm() { list.add(term); }
        (
          ( term=OpIdentifier() { list.add(term); } )+
          term=AsTerm() { list.add(term); }
        )*
   { 
     if(list.size() > 1)
        return new ASTListTerm(list);
     else
        return list.get(0);
   }
}

ASTTerm UpdateTerm():
{
  ASTTerm term;
  List<ASTAssignmentStatement> assignments;
}
{
         "{" assignments=UpdateTerm_List() "}" term=UpdateTerm() 
            { return new ASTUpdateTerm(assignments, term); }
       | term=AsTerm()
            { return term; }
}

List<ASTAssignmentStatement> UpdateTerm_List():	 
{
  Token t;
  ASTTerm term;
  List<ASTAssignmentStatement> assignments = new ArrayList<ASTAssignmentStatement>();
}
{
          t=<IDENTIFIER> ":=" term=Term() 
          	{ assignments.add(new ASTAssignmentStatement(t, term)); }
          ( "||"  t=<IDENTIFIER> ":=" term=Term()
          	{ assignments.add(new ASTAssignmentStatement(t, term)); } )*
          	
          { return assignments; }
}         

ASTTerm AsTerm():
{ 
  ASTTerm term;
  ASTType type; 
}
{
        term=BaseTerm()
        (
          "as"
          type=TypeRef()
            { term = new ASTAsType(term, type); }
        )?  
         { return term; }
}

ASTTerm BaseTerm():
{ 
  ASTTerm term;
}
{
        ( LOOKAHEAD(2) "(" term=BinderTerm() ")"
        | "(" term=Term() ")"
        | term=ApplicationTerm()
        | term=SchemaVariable()
        | term=NumberLiteral()
        | term=ProgramTerm()
        )
        { return term; }
}

ASTTerm ProgramTerm():
{
  ASTProgramTerm pt;
}
{
       "[" pt=ProgramTerm_Content(false) "]" 
           { return pt; } 
           
    |  "[[" pt=ProgramTerm_Content(true) "]" 
           { return pt; }
}

ASTProgramTerm ProgramTerm_Content(boolean termination):
{
  ASTProgramLabel position;
  Token t;
  boolean incremented = false;
  ASTStatement matchStatement = null, st;
  ASTProgramUpdate up;
  List<ASTProgramUpdate> list = new LinkedList<ASTProgramUpdate>();
}
{
       ( t=<NATURAL> 
           { position=new ASTLiteralLabel(t); } 
       | t=<SCHEMALABEL_IDENTIFIER>
          ( "++" { incremented = true; } )?
           { position=new ASTSchemaLabel(t, incremented); }
       )
       
       // never have both!
       ( 
         ":" matchStatement=Statement()
           { return new ASTProgramMatchTerm(position, termination, matchStatement); } 
       |      
         ( "||" t=<NATURAL> ":=" st=Statement() 
           { list.add(new ASTProgramUpdate(new ASTLiteralLabel(t), st)); } )+
       )?
       
       { return new ASTProgramNormalTerm(position, termination, list); }
}

ASTBinderTerm BinderTerm():
{
  Token binderToken;
  Token varToken;
  ASTType type = null; 
  ASTTerm t;
  List<ASTTerm> subterms = new ArrayList<ASTTerm>(); 
}
{
        binderToken = <BINDER_IDENTIFIER>
        
        ( varToken=<IDENTIFIER> | varToken=<SCHEMA_IDENTIFIER> )
        ( "as" type = TypeRef() )?
        ( ";" t=Term() { subterms.add(t); } )+
   { return new ASTBinderTerm(binderToken, type, varToken, subterms); }
}

ASTType TypeRef():
{
  Token token;
  List<ASTType> args = new ArrayList<ASTType>();
  ASTType ty;
}
{
		token = <IDENTIFIER>
		( LOOKAHEAD(2) // a binder declaration may follow, but has a binder-identifier next
		  "(" ty=TypeRef() { args.add(ty); }
		  		( "," ty=TypeRef() { args.add(ty); } )*
		  ")"
		)?
		{ return new ASTTypeApplication(token, args); }
	|
		token = <TYVAR_IDENTIFIER>
		{ return new ASTTypeVar(token); }
}

        
ASTTerm ApplicationTerm():
{
  Token symbol;
  ASTTerm t;
  List<ASTTerm> subterms = new ArrayList<ASTTerm>();
}
{
        (symbol=<IDENTIFIER> | symbol=<META_IDENTIFIER> | symbol=<INTERNAL_IDENTIFIER>)
        
        ( /* parentheses are not empty, constants dont have them */ 
          "("
          t=Term() { subterms.add(t); }
          ( "," t=Term() { subterms.add(t); } )*
          ")"
        )?
        
    { if(subterms.size() > 0) 
        return new ASTApplicationTerm(symbol, subterms); 
      else
        return new ASTIdentifierTerm(symbol);
    }
}

ASTTerm OpIdentifier():
{ 
  Token t;
}
{
        t=<OP_IDENTIFIER> 
  { return new ASTOperatorIdentifierTerm(t); }
}

ASTNumberLiteralTerm NumberLiteral():
{
  Token t;
}
{
        t=<NATURAL>
  { return new ASTNumberLiteralTerm(t); }
}

ASTSchemaVariableTerm SchemaVariable():
{
	Token t;
}
{
        t=<SCHEMA_IDENTIFIER>
  { return new ASTSchemaVariableTerm(t); }
}